<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹¶è¡Œæ£€æµ‹è°ƒè¯•åŠ©æ‰‹</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .debug-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .debug-section h3 {
            margin-top: 0;
            color: #333;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .status-item {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        .status-item.success {
            border-left-color: #28a745;
        }
        .status-item.warning {
            border-left-color: #ffc107;
        }
        .status-item.error {
            border-left-color: #dc3545;
        }
        .batch-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        .batch-table th,
        .batch-table td {
            padding: 8px 12px;
            text-align: left;
            border: 1px solid #ddd;
        }
        .batch-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .batch-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .refresh-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .refresh-btn:hover {
            background: #0056b3;
        }
        .console-log {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” NetWatch å¹¶è¡Œæ£€æµ‹è°ƒè¯•åŠ©æ‰‹</h1>
        <p>æ­¤é¡µé¢å¸®åŠ©è¯Šæ–­å¹¶è¡Œæ£€æµ‹çš„å®Œæˆæ¡ä»¶é—®é¢˜ã€‚è¯·æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ã€‚</p>
        
        <div class="debug-section">
            <h3>ğŸ“Š å½“å‰çŠ¶æ€</h3>
            <button class="refresh-btn" onclick="refreshStatus()">åˆ·æ–°çŠ¶æ€</button>
            <div id="status-display">ç‚¹å‡»åˆ·æ–°æŒ‰é’®è·å–çŠ¶æ€...</div>
        </div>
        
        <div class="debug-section">
            <h3>ğŸ¯ å®Œæˆæ¡ä»¶æ£€æŸ¥</h3>
            <div id="completion-check">ç­‰å¾…æ•°æ®...</div>
        </div>
        
        <div class="debug-section">
            <h3>ğŸ“‹ æ‰¹æ¬¡è¯¦æƒ…</h3>
            <div id="batch-details">ç­‰å¾…æ•°æ®...</div>
        </div>
        
        <div class="debug-section">
            <h3>ğŸ“ æ§åˆ¶å°æ—¥å¿—</h3>
            <div id="console-logs" class="console-log">æ§åˆ¶å°æ—¥å¿—å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>
        </div>
    </div>

    <script>
        let logs = [];
        
        // æ‹¦æˆªconsole.log
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addLog('LOG', args.join(' '));
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addLog('WARN', args.join(' '));
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addLog('ERROR', args.join(' '));
        };
        
        function addLog(level, message) {
            const timestamp = new Date().toLocaleTimeString();
            logs.push(`[${timestamp}] ${level}: ${message}`);
            
            // ä¿æŒæœ€è¿‘100æ¡æ—¥å¿—
            if (logs.length > 100) {
                logs = logs.slice(-100);
            }
            
            updateConsoleDisplay();
        }
        
        function updateConsoleDisplay() {
            const consoleDiv = document.getElementById('console-logs');
            consoleDiv.textContent = logs.join('\n');
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }
        
        async function refreshStatus() {
            try {
                const response = await fetch('?ajax=1&action=getParallelProgress');
                const data = await response.json();
                
                if (data.success) {
                    displayStatus(data);
                    checkCompletionConditions(data);
                    displayBatchDetails(data);
                } else {
                    document.getElementById('status-display').innerHTML = 
                        '<div class="status-item error">âŒ è·å–çŠ¶æ€å¤±è´¥</div>';
                }
            } catch (error) {
                console.error('è·å–çŠ¶æ€å¤±è´¥:', error);
                document.getElementById('status-display').innerHTML = 
                    '<div class="status-item error">âŒ ç½‘ç»œé”™è¯¯: ' + error.message + '</div>';
            }
        }
        
        function displayStatus(data) {
            const progress = data.overall_progress;
            const completedBatches = data.batch_statuses.filter(b => b.status === 'completed').length;
            const runningBatches = data.batch_statuses.filter(b => b.status === 'running').length;
            
            const html = `
                <div class="status-grid">
                    <div class="status-item ${progress >= 100 ? 'success' : 'warning'}">
                        <strong>æ€»ä½“è¿›åº¦:</strong> ${progress.toFixed(2)}%
                    </div>
                    <div class="status-item">
                        <strong>æ£€æµ‹è¿›åº¦:</strong> ${data.total_checked}/${data.total_proxies}
                    </div>
                    <div class="status-item">
                        <strong>åœ¨çº¿ä»£ç†:</strong> ${data.total_online}
                    </div>
                    <div class="status-item">
                        <strong>ç¦»çº¿ä»£ç†:</strong> ${data.total_offline}
                    </div>
                    <div class="status-item ${completedBatches >= data.total_batches ? 'success' : 'warning'}">
                        <strong>å®Œæˆæ‰¹æ¬¡:</strong> ${completedBatches}/${data.total_batches}
                    </div>
                    <div class="status-item ${runningBatches === 0 ? 'success' : 'warning'}">
                        <strong>è¿è¡Œæ‰¹æ¬¡:</strong> ${runningBatches}
                    </div>
                </div>
            `;
            
            document.getElementById('status-display').innerHTML = html;
        }
        
        function checkCompletionConditions(data) {
            const progress = data.overall_progress;
            const completedBatches = data.batch_statuses.filter(b => b.status === 'completed').length;
            const runningBatches = data.batch_statuses.filter(b => b.status === 'running').length;
            
            const allBatchesCompleted = completedBatches >= data.total_batches;
            const progressComplete = progress >= 100;
            const allProxiesChecked = data.total_checked >= data.total_proxies;
            const hasRunningBatches = runningBatches > 0;
            
            const shouldComplete = allBatchesCompleted && !hasRunningBatches && allProxiesChecked;
            
            const html = `
                <div class="status-grid">
                    <div class="status-item ${allBatchesCompleted ? 'success' : 'error'}">
                        <strong>æ‰€æœ‰æ‰¹æ¬¡å®Œæˆ:</strong> ${allBatchesCompleted ? 'æ˜¯' : 'å¦'}
                    </div>
                    <div class="status-item ${!hasRunningBatches ? 'success' : 'error'}">
                        <strong>æ²¡æœ‰è¿è¡Œæ‰¹æ¬¡:</strong> ${!hasRunningBatches ? 'æ˜¯' : 'å¦'}
                    </div>
                    <div class="status-item ${allProxiesChecked ? 'success' : 'error'}">
                        <strong>æ‰€æœ‰ä»£ç†æ£€æµ‹å®Œæˆ:</strong> ${allProxiesChecked ? 'æ˜¯' : 'å¦'}
                    </div>
                    <div class="status-item ${progressComplete ? 'success' : 'warning'}">
                        <strong>è¿›åº¦å®Œæˆ:</strong> ${progressComplete ? 'æ˜¯' : 'å¦'}
                    </div>
                    <div class="status-item ${shouldComplete ? 'success' : 'error'}">
                        <strong>åº”è¯¥æ˜¾ç¤ºå®Œæˆ:</strong> ${shouldComplete ? 'æ˜¯' : 'å¦'}
                    </div>
                </div>
            `;
            
            document.getElementById('completion-check').innerHTML = html;
            
            // è®°å½•åˆ°æ§åˆ¶å°
            console.log('å®Œæˆæ¡ä»¶æ£€æŸ¥ (è°ƒè¯•é¡µé¢):', {
                allBatchesCompleted,
                hasRunningBatches,
                allProxiesChecked,
                progressComplete,
                shouldComplete,
                completedBatches,
                totalBatches: data.total_batches,
                runningBatches,
                totalChecked: data.total_checked,
                totalProxies: data.total_proxies
            });
        }
        
        function displayBatchDetails(data) {
            let html = '<table class="batch-table"><thead><tr>';
            html += '<th>æ‰¹æ¬¡ID</th><th>çŠ¶æ€</th><th>è¿›åº¦</th><th>å·²æ£€æµ‹</th><th>æ€»æ•°</th><th>åœ¨çº¿</th><th>ç¦»çº¿</th>';
            html += '</tr></thead><tbody>';
            
            data.batch_statuses.forEach(batch => {
                const statusClass = batch.status === 'completed' ? 'success' : 
                                   batch.status === 'running' ? 'warning' : 'error';
                html += `<tr class="${statusClass}">`;
                html += `<td>${batch.batch_id || 'N/A'}</td>`;
                html += `<td>${batch.status || 'unknown'}</td>`;
                html += `<td>${(batch.progress || 0).toFixed(1)}%</td>`;
                html += `<td>${batch.checked || 0}</td>`;
                html += `<td>${batch.limit || 0}</td>`;
                html += `<td>${batch.online || 0}</td>`;
                html += `<td>${batch.offline || 0}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            document.getElementById('batch-details').innerHTML = html;
        }
        
        // è‡ªåŠ¨åˆ·æ–°
        setInterval(refreshStatus, 2000);
        
        // åˆå§‹åŠ è½½
        refreshStatus();
    </script>
</body>
</html>
