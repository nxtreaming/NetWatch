# NetWatch 并行代理检测功能

## 概述

NetWatch 系统现在支持高性能的并行代理检测功能，能够显著提升大量代理的检测效率。通过将代理分组并行处理，检测速度可提升 3-6 倍。

## 功能特点

### 🚀 高性能并行处理
- **分组处理**: 每400个代理为一组进行并行检测
- **多进程并行**: 最多6个批次同时执行
- **智能调度**: 自动管理进程启动和完成
- **实时监控**: 提供详细的进度反馈

### 📊 性能提升对比
- **串行检测**: 2300个代理约需 3-4 小时
- **并行检测**: 2300个代理约需 40-60 分钟
- **性能提升**: 3-6倍速度提升

### 🎯 用户体验优化
- **美观界面**: 现代化的进度显示界面
- **实时反馈**: 每秒更新进度和统计信息
- **可取消操作**: 随时取消正在进行的检测
- **详细统计**: 显示批次执行情况和性能数据

## 使用方法

### 1. Web界面使用
1. 登录NetWatch系统
2. 在代理列表页面点击 **🚀 并行检测** 按钮
3. 系统将显示并行检测进度界面
4. 等待检测完成或点击"取消检测"中止

### 2. 功能按钮
- **检查所有代理**: 传统的串行检测方式
- **🚀 并行检测**: 新的高性能并行检测方式

## 技术架构

### 核心组件
1. **ParallelMonitor**: 并行检测管理器
2. **parallel_batch_manager.php**: 批次管理器
3. **parallel_worker.php**: 工作进程
4. **前端JavaScript**: 进度监控和用户界面

### 工作流程
```
用户点击并行检测
    ↓
启动ParallelMonitor
    ↓
创建临时状态文件
    ↓
异步启动批次管理器
    ↓
批次管理器启动多个工作进程
    ↓
工作进程并行检测代理
    ↓
实时更新进度状态
    ↓
检测完成，显示结果
```

### 文件结构
```
NetWatch/
├── parallel_monitor.php          # 并行检测管理器
├── parallel_batch_manager.php    # 批次管理器
├── parallel_worker.php           # 工作进程
├── test_parallel_monitor.php     # 测试脚本
└── PARALLEL_CHECK_README.md      # 说明文档
```

## 配置参数

### 配置常量（index.php）
```php
// 并行检测配置常量
define('PARALLEL_MAX_PROCESSES', 6);  // 最大并行进程数
define('PARALLEL_BATCH_SIZE', 400);   // 每批次代理数量
```

系统默认配置：
- 批次大小：400个代理/批次（可通过PARALLEL_BATCH_SIZE调整）
- 最大并行进程：6个（可通过PARALLEL_MAX_PROCESSES调整）
- 检测超时：5秒/代理
- 连接超时：3秒/代理

### 配置调整建议
- **服务器配置较低**：减少PARALLEL_MAX_PROCESSES到3-4
- **网络较慢**：减少PARALLEL_BATCH_SIZE到200-300
- **服务器配置较高**：可增加PARALLEL_MAX_PROCESSES到8-10
- **网络较快**：可增加PARALLEL_BATCH_SIZE到500-600

### 自定义配置
推荐通过修改 `index.php` 中的常量来调整配置：
```php
// 在 index.php 顶部修改这些常量
define('PARALLEL_MAX_PROCESSES', 8);   // 调整最大并行进程数
define('PARALLEL_BATCH_SIZE', 300);    // 调整每批次代理数量
```

系统会自动使用这些常量：
```php
// 系统自动使用常量创建实例
$parallelMonitor = new ParallelMonitor(
    PARALLEL_MAX_PROCESSES,  // 使用常量值
    PARALLEL_BATCH_SIZE      // 使用常量值
);
```

## 性能优化建议

### 服务器配置
- **CPU**: 多核CPU能更好地支持并行处理
- **内存**: 建议至少2GB可用内存
- **网络**: 稳定的网络连接确保检测准确性

### 参数调优
- **代理数量 < 500**: 建议使用串行检测
- **代理数量 500-2000**: 并行检测效果显著
- **代理数量 > 2000**: 强烈建议使用并行检测

### 批次大小调整
- **网络较慢**: 减少批次大小到200-300
- **网络较快**: 可增加批次大小到500-600
- **服务器性能较低**: 减少最大并行进程数到3-4

## 故障排除

### 常见问题

#### 1. 并行检测无法启动
**可能原因**: 临时目录权限不足
**解决方案**: 确保PHP有权限写入系统临时目录

#### 2. 进程启动失败
**可能原因**: PHP CLI不可用或路径错误
**解决方案**: 检查PHP CLI是否正确安装

#### 3. 检测进度卡住
**可能原因**: 工作进程异常退出
**解决方案**: 查看日志文件，重启检测

#### 4. Windows系统兼容性
**可能原因**: Windows进程管理差异
**解决方案**: 系统已自动适配Windows命令

### 调试工具

#### 测试脚本
运行测试脚本检查系统状态：
```bash
php test_parallel_monitor.php
```

#### 日志查看
检查系统日志了解详细信息：
- 应用日志: `logs/` 目录
- 系统日志: PHP错误日志

## 安全考虑

### 进程管理
- 自动清理临时文件
- 进程异常时自动终止
- 防止进程泄漏

### 资源控制
- 限制最大并行进程数
- 设置执行时间限制
- 内存使用监控

## 更新日志

### v1.0.0 (2025-01-20)
- ✅ 实现基础并行检测功能
- ✅ 添加Web界面支持
- ✅ 创建测试和文档
- ✅ Windows系统兼容性
- ✅ 实时进度监控
- ✅ 错误处理和恢复

## 技术支持

如果您在使用并行检测功能时遇到问题，请：

1. 运行测试脚本进行诊断
2. 查看系统日志了解错误详情
3. 检查服务器资源使用情况
4. 尝试调整配置参数

## 性能基准测试

### 测试环境
- **服务器**: 4核CPU, 8GB内存
- **代理数量**: 2300个
- **网络**: 100Mbps

### 测试结果
- **串行检测**: 3小时45分钟
- **并行检测**: 52分钟
- **性能提升**: 4.3倍

### 资源使用
- **CPU使用率**: 60-80%
- **内存使用**: 约500MB
- **网络带宽**: 充分利用

---

**注意**: 并行检测功能需要服务器支持多进程处理。在共享主机环境中可能受到限制。
